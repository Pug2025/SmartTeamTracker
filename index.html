<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Team Tracker – iPhone (v5.0.0)</title>
<style>
  :root{
    /* Theme: High Contrast / Split Brain */
    --bg:#000000; 
    --panel:#111111; 
    --ink:#ffffff; 
    --muted:#888888; 
    
    /* Zones */
    --zone-us:#0a1a2a;       /* Dark Blue background for 'Us' */
    --zone-them:#1f0a0a;     /* Dark Red background for 'Them' */
    --accent-us:#4da3ff;     /* Bright Blue */
    --accent-them:#ff453a;   /* Bright Red */
    --good:#32d74b; 
    --warn:#ff9f0a;
    
    --radius:16px;
    --header-height:100px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--ink);
    padding-bottom:80px; /* Space for FAB */
  }

  /* Basic utility / text classes */
  .inlineRow{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .small{
    font-size:12px;
    color:var(--muted);
  }
  .banner{
    font-size:12px;
    padding:6px 10px;
    border-radius:10px;
    background:#1a1200;
    border:1px solid #444;
  }
  .card{
    background:#111;
    border:1px solid #333;
    border-radius:12px;
    padding:10px;
  }
  .btn{
    font-family:inherit;
  }

  /* ===== Sticky Header & Scoreboard ===== */
  .sticky-header{
    position:sticky;
    top:0;
    z-index:1000;
    background:rgba(10,10,10,0.95);
    backdrop-filter:blur(10px);
    border-bottom:1px solid #333;
    padding-bottom:10px;
  }
  .top-row{
    display:flex; 
    justify-content:space-between; 
    align-items:center;
    padding:8px 14px;
  }
  .top-row h1{ 
    font-size:18px; 
    margin:0; 
    font-weight:700; 
    letter-spacing:-0.5px; 
  }
  
  .scoreboard-row{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    padding:0 14px 6px 14px;
    gap:12px;
  }
  .score-block{
    display:flex; 
    flex-direction:column;
    border-radius:12px;
    padding:6px 10px;
    position:relative;
  }
  .score-block.us{ 
    background:var(--zone-us); 
    border:1px solid #1a3a5a; 
    align-items:flex-end; 
  }
  .score-block.them{ 
    background:var(--zone-them); 
    border:1px solid #5a1a1a; 
    align-items:flex-start; 
  }
  
  .score-label{ 
    font-size:11px; 
    text-transform:uppercase; 
    color:var(--muted); 
    font-weight:700; 
    letter-spacing:0.5px; 
  }
  .score-val{ 
    font-size:32px; 
    font-weight:800; 
    line-height:1; 
    margin-top:2px; 
    transition: transform 0.1s; 
  }
  
  /* Pulse Animation for Score */
  @keyframes pulse-green { 
    0% {color:#fff;} 
    50% {color:var(--good); transform:scale(1.2);} 
    100% {color:#fff;} 
  }
  @keyframes pulse-red { 
    0% {color:#fff;} 
    50% {color:var(--accent-them); transform:scale(1.2);} 
    100% {color:#fff;} 
  }
  .pulse-good { animation: pulse-green 0.4s ease-out; }
  .pulse-bad { animation: pulse-red 0.4s ease-out; }

  /* Period Selector (Segmented) */
  .period-seg{
    display:flex;
    background:#1c1c1e;
    border-radius:10px;
    padding:3px;
    border:1px solid #333;
  }
  .p-opt{
    padding:6px 10px;
    font-size:13px;
    font-weight:700;
    border-radius:7px;
    color:var(--muted);
    cursor:pointer;
  }
  .p-opt.active{
    background:#444;
    color:#fff;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  }

  .wrap{
    max-width:520px;
    margin:0 auto;
    padding:14px;
  }
  
  /* ===== Setup Panel (Collapsible) ===== */
  #setupContainer{ display:block; }
  #gameControls{ display:none; }
  .setup-card{
    background:var(--panel);
    border:1px solid #333;
    border-radius:var(--radius);
    padding:20px;
    margin-top:20px;
    text-align:center;
  }
  .setup-card h2{ 
    margin-top:0; 
    font-size:18px; 
  }
  .input-group{ 
    text-align:left; 
    margin-bottom:12px; 
  }
  label{ 
    display:block; 
    font-size:12px; 
    color:var(--muted); 
    margin-bottom:6px; 
  }
  input, select{
    width:100%; 
    box-sizing:border-box;
    background:#000; 
    border:1px solid #333; 
    color:#fff;
    padding:12px; 
    border-radius:10px; 
    font-size:16px; 
    outline:none;
  }
  .btn-start{
    width:100%; 
    background:var(--accent-us); 
    color:#000; 
    border:none;
    padding:16px; 
    font-size:18px; 
    font-weight:800; 
    border-radius:14px;
    margin-top:10px; 
    cursor:pointer;
  }
  .btn-edit-setup{
    background:none; 
    border:none; 
    color:var(--muted);
    font-size:12px; 
    text-decoration:underline; 
    padding:0; 
    margin:0;
    cursor:pointer;
  }

  /* ===== Split Brain Controls ===== */
  .split-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .col-zone{
    display:flex; 
    flex-direction:column; 
    gap:8px;
  }
  
  /* Button Styling */
  .g-btn{
    -webkit-tap-highlight-color:transparent;
    border-radius:12px; 
    border:1px solid;
    color:#fff; 
    font-weight:700; 
    font-size:15px;
    display:flex; 
    align-items:center; 
    justify-content:center; 
    text-align:center;
    cursor:pointer; 
    user-select:none;
    touch-action:manipulation;
    transition:transform 0.05s, opacity 0.1s, box-shadow 0.15s;
    box-shadow:none;
  }
  .g-btn:active{ 
    transform:scale(0.97); 
    opacity:0.8; 
  }
  .g-btn.primary{
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }

  /* Sizes */
  .h-lg{ 
    height:85px; 
    font-size:18px; 
    font-weight:800; 
  } /* Primary Action */
  .h-md{ 
    height:55px; 
    font-size:14px; 
  }
  
  /* Theme: THEM (Left/Red) */
  .theme-them .g-btn{ 
    background:var(--zone-them); 
    border-color:#5a1a1a; 
  }
  .theme-them .g-btn.primary{ 
    background:#3a0e0e; 
    border-color:var(--accent-them); 
  }
  .theme-them .g-btn.ctx{ 
    background:#140707; 
    border-color:#5a1a1a; 
    border-style:dashed; 
    font-size:12px;
  }
  
  /* Theme: US (Right/Blue) */
  .theme-us .g-btn{ 
    background:var(--zone-us); 
    border-color:#1a3a5a; 
  }
  .theme-us .g-btn.primary{ 
    background:#0f2b45; 
    border-color:var(--accent-us); 
    box-shadow:0 4px 10px rgba(0,0,0,0.4);
  }
  .theme-us .g-btn.positive{ 
    border-color:var(--good); 
    color:var(--good); 
  } /* Smother/Saves */
  
  /* Grid dividers/labels */
  .col-label{
    font-size:10px; 
    text-transform:uppercase; 
    letter-spacing:1px; 
    text-align:center; 
    margin-bottom:4px; 
    opacity:0.5;
  }
  .col-sub-label{
    font-size:10px;
    text-align:center;
    opacity:0.5;
  }

  .def-context-label{
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:0.8px;
    opacity:0.6;
    margin-top:4px;
  }

  /* ===== Next Period Full-Width Bar ===== */
  .next-period-wrap{
    margin-top:14px;
  }
  .next-period-btn{
    width:100%;
    background:#222;
    border-color:#444;
    font-size:14px;
    border-radius:999px;
  }

  /* ===== Floating Undo (FAB) ===== */
  .fab-undo{
    position:fixed; 
    bottom:24px; 
    right:24px;
    width:64px; 
    height:64px; 
    border-radius:50%;
    background:#222; 
    border:2px solid #444;
    color:#fff; 
    font-size:12px; 
    font-weight:700;
    display:flex; 
    align-items:center; 
    justify-content:center;
    box-shadow:0 8px 24px rgba(0,0,0,0.5);
    z-index:2000; 
    cursor:pointer;
  }
  .fab-undo:active{ 
    transform:scale(0.95); 
    background:#333; 
  }

  /* ===== Stats & Log ===== */
  .stats-strip{
    display:grid; 
    grid-template-columns:repeat(4, 1fr); 
    gap:6px;
    margin-top:16px;
  }
  .mini-stat{
    background:#111; 
    border:1px solid #222; 
    border-radius:8px; 
    padding:6px;
    text-align:center;
  }
  .mini-stat .l{ 
    font-size:10px; 
    color:var(--muted); 
    display:block; 
  }
  .mini-stat .v{ 
    font-size:14px; 
    font-weight:700; 
    color:#fff; 
  }

  .log-container{
    margin-top:16px;
    background:#080808; 
    border:1px solid #222; 
    border-radius:12px;
    height:140px; 
    overflow-y:auto; 
    padding:8px;
  }
  .log-item{ 
    font-size:12px; 
    padding:4px 0; 
    border-bottom:1px dashed #222; 
    color:#ccc; 
    display:flex;
    justify-content:space-between;
    gap:8px;
    align-items:center;
  }
  .log-main{
    flex:1;
  }
  .log-meta{
    opacity:0.7;
    margin-right:4px;
  }
  .badge{
    display:inline-block;
    padding:2px 6px;
    border-radius:8px;
    border:1px solid #333;
    font-size:10px;
    margin-left:4px;
  }
  .badge-tag{
    border-color:var(--accent-us);
    color:var(--accent-us);
    cursor:pointer;
  }

  /* ===== Summary Panels / Dialogs (reused) ===== */
  .panel{ 
    background:var(--panel); 
    border-radius:var(--radius); 
    padding:12px; 
    margin-top:10px; 
    border:1px solid #333;
  }
  .hidden{ display:none!important; }
  .modal{ 
    position:fixed; 
    inset:0; 
    background:rgba(0,0,0,0.8); 
    z-index:9999; 
    display:none; 
    align-items:center; 
    justify-content:center; 
    padding:16px; 
  }
  .modal .box{ 
    background:#111; 
    border:1px solid #333; 
    border-radius:12px; 
    width:100%; 
    max-width:400px; 
    padding:16px; 
  }
  
  /* Rings (now in summary) */
  .scoreRing{ 
    position:relative; 
    width:80px; 
    height:80px; 
    margin:0 auto; 
  }
  .ringSvg{ 
    transform:rotate(-90deg); 
    width:100%; 
    height:100%; 
  }
  .ringBg{ 
    fill:none; 
    stroke:#333; 
    stroke-width:6; 
  }
  .ringFg{ 
    fill:none; 
    stroke:var(--accent-us); 
    stroke-width:6; 
    stroke-linecap:round; 
    transition:stroke-dashoffset 0.5s; 
    stroke-dasharray:220; 
    stroke-dashoffset:220; 
  }
  .scoreRing .val{ 
    position:absolute; 
    inset:0; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:24px; 
    font-weight:800; 
  }
  
  .pill{ 
    font-size:10px; 
    padding:3px 8px; 
    border-radius:10px; 
    background:#222; 
    border:1px solid #333; 
    color:#888; 
  }
  .pill.good{ 
    color:var(--good); 
    border-color:var(--good); 
  }
  .pill.warn{ 
    color:var(--warn); 
    border-color:var(--warn); 
  }
  .pill.bad{ 
    color:var(--accent-them); 
    border-color:var(--accent-them); 
  }
  
  .ai-actions{ 
    display:flex; 
    flex-wrap:wrap; 
    gap:8px; 
    margin-top:10px; 
  }
  .btn.ai{ 
    padding:10px; 
    background:#1a1a1a; 
    border:1px solid #333; 
    color:#ccc; 
    border-radius:8px; 
    flex:1; 
  }

  /* Common utils */
  .rowbtn{ 
    display:flex; 
    gap:10px; 
    margin-top:10px; 
    justify-content:flex-end; 
  }
  .btn-std{ 
    padding:10px 16px; 
    background:#222; 
    border:1px solid #444; 
    color:#fff; 
    border-radius:8px; 
    cursor:pointer;
  }
  
  /* Picker Grid */
  .pickerGrid{ 
    display:grid; 
    grid-template-columns:repeat(4,1fr); 
    gap:8px; 
    margin-top:10px; 
  }
  .pickerBtn{ 
    background:#222; 
    border:1px solid #333; 
    padding:12px; 
    border-radius:8px; 
    text-align:center; 
    font-weight:700; 
    cursor:pointer; 
  }
  .pickerBtn.selected{ 
    background:#0f2b45; 
    border-color:var(--accent-us); 
  }

  /* Tables in summary */
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:12px;
  }
  th,td{
    border:1px solid #333;
    padding:4px 6px;
    text-align:center;
  }
  th{
    background:#181818;
  }

  /* Undo Modal */
  .undoRow{
    padding:6px 4px;
    border-bottom:1px solid #222;
    cursor:pointer;
    font-size:12px;
  }

  /* Toast */
  .toast{
    position:fixed;
    left:50%;
    bottom:12px;
    transform:translateX(-50%);
    background:#111;
    border:1px solid #333;
    border-radius:20px;
    padding:8px 14px;
    font-size:12px;
    display:none;
    z-index:3000;
  }
</style>
</head>
<body>

<!-- Sticky Header -->
<header class="sticky-header">
  <div class="top-row">
    <div class="inlineRow">
      <h1>Team Tracker</h1>
      <div class="pill" id="cloudStatus">Cloud: —</div>
    </div>
    <div>
      <button class="btn-edit-setup" id="btnEditSetup" style="display:none;">Edit Info</button>
      <button class="btn-std" id="btnRoster" style="font-size:11px; padding:6px 10px;">Roster</button>
    </div>
  </div>

  <div class="scoreboard-row">
    <!-- THEM LEFT, US RIGHT -->
    <div class="score-block them">
      <span class="score-label">THEM</span>
      <span id="liveGA" class="score-val">0</span>
    </div>

    <div class="period-seg" id="periodChips">
      <div class="p-opt active" data-p="1">1</div>
      <div class="p-opt" data-p="2">2</div>
      <div class="p-opt" data-p="3">3</div>
      <div class="p-opt" data-p="4">OT</div>
    </div>

    <div class="score-block us">
      <span class="score-label">US</span>
      <span id="liveGF" class="score-val">0</span>
    </div>
  </div>
</header>

<div class="wrap">
  
  <!-- Setup Panel (Initially Visible) -->
  <div id="setupContainer">
    <div class="setup-card">
      <h2>Game Setup</h2>
      <div class="input-group">
        <label>Opponent Name</label>
        <input id="opponent" placeholder="e.g. Napanee Stars" autocomplete="off">
      </div>
      <div class="input-group">
        <label>Level</label>
        <select id="level">
          <option>U9</option>
          <option selected>U11</option>
          <option>U13</option>
          <option>U15</option>
          <option>U18</option>
          <option>Other</option>
        </select>
      </div>
      <div class="input-group">
        <label>Date</label>
        <input id="date" type="date">
      </div>
      <div id="resumeBanner" class="banner hidden" style="font-size:12px; color:var(--warn); margin-bottom:10px;">Resumed saved game.</div>
      <button id="btnStartGame" class="btn-start">Start Game</button>
    </div>
  </div>

  <!-- Game Controls (Initially Hidden) -->
  <div id="gameControls">
    
    <div class="split-grid">
      
      <!-- LEFT COLUMN: THEM / BAD (Red) -->
      <div class="col-zone theme-them">
        <div class="col-label">Them</div>
        <!-- Primary -->
        <div class="g-btn primary h-lg" id="btnShot">Shot Against</div>
        <div class="g-btn primary h-lg" id="btnGoal">Goal Against</div>
        <!-- Secondary -->
        <div class="g-btn h-md" id="btnSoftGoal">Soft Goal</div>
        <div class="g-btn h-md" id="btnBadRebound">Bad Rebound</div>
        <!-- Defensive Context label -->
        <div class="def-context-label">Defensive Context</div>
        <!-- Context -->
        <div class="g-btn ctx h-md" id="btnBreakaway">Breakaway Ag</div>
        <div class="g-btn ctx h-md" id="btnDZTurnover">DZ Turnover</div>
      </div>

      <!-- RIGHT COLUMN: US / GOOD (Blue) -->
      <div class="col-zone theme-us">
        <div class="col-label">Us</div>
        <!-- Primary -->
        <div class="g-btn primary h-lg" id="btnForShot">Shot For</div>
        <div class="g-btn primary h-lg" id="btnForGoal">Goal For</div>
        <!-- Goalies -->
        <div class="g-btn positive h-md" id="btnSmother">Smother</div>
        <div class="g-btn positive h-md" id="btnBigSave">Big Save</div>
      </div>

    </div>

    <!-- Next Period: global full-width control -->
    <div class="next-period-wrap">
      <div class="g-btn next-period-btn" id="btnNextPeriod">Next Period</div>
    </div>

    <!-- Stats Strip -->
    <div class="stats-strip">
      <div class="mini-stat"><span class="l">SF</span><span class="v" id="liveSF">0</span></div>
      <div class="mini-stat"><span class="l">SA</span><span class="v" id="liveSA">0</span></div>
      <div class="mini-stat"><span class="l">Saves</span><span class="v" id="savesVal">0</span></div>
      <div class="mini-stat"><span class="l">SV%</span><span class="v" id="svVal">—</span></div>
    </div>

    <!-- Log -->
    <div class="log-container" id="log"></div>

    <div class="rowbtn" style="justify-content:center; margin-top:20px;">
      <button class="btn-std" id="btnEnd" style="border-color:var(--good); color:var(--good);">End Game &amp; Score</button>
      <button class="btn-std" id="btnReset">New Game</button>
    </div>

  </div> <!-- End Game Controls -->

  <!-- Summary Panel -->
  <section class="panel hidden" id="summaryPanel">
    <h2 style="margin:0 0 10px 0; font-size:16px;">Game Summary</h2>
    <div id="summaryTitle" class="small" style="margin-bottom:12px; color:#aaa;"></div>

    <div style="display:flex; justify-content:center; gap:20px; margin-bottom:20px;">
      <div style="text-align:center;">
        <div class="scoreRing" id="gsRing">
           <svg viewBox="0 0 80 80" class="ringSvg"><circle class="ringBg" cx="40" cy="40" r="35"></circle><circle class="ringFg" id="gsArc" cx="40" cy="40" r="35"></circle></svg>
           <div class="val" id="goalieScoreNum">—</div>
        </div>
        <div class="small" style="margin-top:6px;">Goalie Score</div>
      </div>
      <div style="text-align:center;">
        <div class="scoreRing" id="tsRing">
           <svg viewBox="0 0 80 80" class="ringSvg"><circle class="ringBg" cx="40" cy="40" r="35"></circle><circle class="ringFg" id="tsArc" cx="40" cy="40" r="35"></circle></svg>
           <div class="val" id="teamScoreNum">—</div>
        </div>
        <div class="small" style="margin-top:6px;">Team Score</div>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <h3>Goalie Breakdown</h3>
      <div class="small" id="scoreBreakdown"></div>
    </div>
    <div class="card" style="margin-top:10px;">
      <h3>Team Breakdown</h3>
      <div class="small" id="teamBreakdown"></div>
    </div>

    <div id="summaryReadable" style="margin-top:15px; font-size:13px; line-height:1.5;"></div>
    <div id="summaryTableWrap" style="margin-top:15px;"></div>
    <div id="pmTableWrap" style="margin-top:15px;"></div>
    <div id="gaDetailWrap" style="margin-top:15px;"></div>

    <div class="ai-actions">
      <button class="btn ai" id="btnSaveSeason">Save to Season</button>
      <button class="btn ai" id="btnAIPractice">Practice Plan</button>
      <button class="btn ai" id="btnAIGoalieReport">Goalie Report</button>
      <button class="btn ai" id="btnAIFocus">Next Game Focus</button>
    </div>

    <!-- AI Results Cards -->
    <div class="card" id="aiPracticeCard" style="margin-top:10px;display:none;">
      <h3>AI Practice Plan</h3><div class="small" id="aiPracticeBody"></div>
    </div>
    <div class="card" id="aiGoalieCard" style="margin-top:10px;display:none;">
      <h3>AI Goalie Report</h3><div class="small" id="aiGoalieBody"></div>
    </div>
    <div class="card" id="aiFocusCard" style="margin-top:10px;display:none;">
      <h3>AI Next Game Focus</h3><div class="small" id="aiFocusBody"></div>
    </div>

    <div class="rowbtn" style="margin-top:20px; justify-content:center;">
      <button class="btn-std" id="btnExportGameCSV">Export CSV</button>
      <button class="btn-std" id="btnCopySummary">Copy Text</button>
    </div>
  </section>

</div>

<!-- Floating Undo Button -->
<div id="btnUndo" class="fab-undo">UNDO</div>

<!-- MODALS -->
<!-- Roster modal -->
<div class="modal" id="rosterModal"><div class="box">
  <div class="small" style="margin-bottom:6px;">Roster (one # per line)</div>
  <textarea id="rosterArea" style="width:100%; height:150px; background:#000; border:1px solid #333; color:#fff; padding:8px;"></textarea>
  <div class="rowbtn">
    <button class="btn-std" id="btnRosterSave">Save</button>
    <button class="btn-std" id="btnRosterClose" style="border-color:#444;">Close</button>
  </div>
</div></div>

<!-- Player picker -->
<div class="modal" id="pickerModal"><div class="box">
  <div class="small" style="margin-bottom:8px;" id="pickerTitle">Select Player</div>
  <div class="pickerGrid" id="pickerGrid"></div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <input id="pickerInput" placeholder="#" type="tel" style="flex:1;">
    <button class="btn-std" id="pickerAdd">Use</button>
  </div>
  <div class="rowbtn">
    <button class="btn-std" id="pickerUnknown">Unknown</button>
    <button class="btn-std" id="pickerCancel">Cancel</button>
  </div>
</div></div>

<!-- GA Context -->
<div class="modal" id="gaOverlay"><div class="box">
  <div class="small" style="margin-bottom:8px;">Goal Context</div>
  <div class="pickerGrid" id="gaGrid" style="grid-template-columns:1fr 1fr;"></div>
  <div class="rowbtn">
    <button class="btn-std" id="gaSkip">Tag Later</button>
  </div>
</div></div>

<!-- Multi Picker -->
<div class="modal" id="onIceModal"><div class="box">
  <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
    <span class="small" id="onIceTitle">On Ice</span>
    <span class="small"><span id="onIceCount">0</span>/<span id="onIceMax">5</span></span>
  </div>
  <div class="pickerGrid" id="onIceGrid"></div>
  <div class="rowbtn" style="justify-content:space-between; margin-top:12px;">
    <button class="btn-std" id="onIceUnknownPlus">Unk +</button>
    <button class="btn-std" id="onIceUnknownMinus">Unk -</button>
    <button class="btn-std" id="onIceClear">Clear</button>
  </div>
  <div class="rowbtn">
    <button class="btn-std" id="onIceUse" style="border-color:var(--good); color:var(--good);">Use</button>
    <button class="btn-std" id="onIceCancel">Skip</button>
  </div>
  <div class="small" id="onIceUnknownBadge" style="text-align:center; margin-top:6px; opacity:0.5;"></div>
</div></div>

<!-- Strength -->
<div class="modal" id="strengthModal"><div class="box">
  <div class="small" style="margin-bottom:8px;" id="strengthTitle">Situation</div>
  <div class="pickerGrid" style="grid-template-columns:1fr;">
    <div class="pickerBtn" data-strength="EV">Even Strength (EV)</div>
    <div class="pickerBtn" data-strength="PP">Power Play (PP)</div>
    <div class="pickerBtn" data-strength="SH">Short Handed (SH)</div>
  </div>
  <div class="rowbtn"><button class="btn-std" id="strengthSkip">Skip</button></div>
</div></div>

<!-- Copy -->
<div class="modal" id="copyModal"><div class="box">
  <div class="small">Summary Text</div>
  <textarea id="copyArea" style="width:100%; height:200px; background:#000; color:#fff; margin-top:8px;"></textarea>
  <div class="rowbtn">
    <button class="btn-std" id="btnCopySelect">Select All</button>
    <button class="btn-std" id="btnCopyClose">Close</button>
  </div>
</div></div>

<!-- Undo List -->
<div class="modal" id="undoModal"><div class="box">
  <div class="small">Undo Event</div>
  <div class="undoList" id="undoList" style="max-height:250px; overflow:auto; margin-top:8px;"></div>
  <div class="rowbtn"><button class="btn-std" id="undoClose">Cancel</button></div>
</div></div>

<div class="toast" id="toast">Removed. <button id="toastRestore" style="background:none; border:none; color:var(--accent-us); font-weight:700;">Restore</button></div>

<!-- Debug (Hidden by default in UI but kept for ref) -->
<div id="debugWrap" style="display:none;">
  <div id="debugGoalieLine"></div><div id="debugTeamLine"></div>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=>navigator.serviceWorker.register('service-worker.js?v=5000'));
}

/* ===== IndexedDB KV helper ===== */
const idbKV = (() => {
  let dbp;
  function db(){
    if (dbp) return dbp;
    dbp = new Promise((resolve,reject)=>{
      const open = indexedDB.open('team-tracker-db',1);
      open.onupgradeneeded = () => open.result.createObjectStore('kvs');
      open.onerror = () => reject(open.error);
      open.onsuccess = () => resolve(open.result);
    });
    return dbp;
  }
  async function get(key){
    const d = await db();
    return new Promise((res,rej)=>{
      const r = d.transaction('kvs','readonly').objectStore('kvs').get(key);
      r.onsuccess = () => res(r.result);
      r.onerror = () => rej(r.error);
    });
  }
  async function set(key,val){
    const d = await db();
    return new Promise((res,rej)=>{
      const w = d.transaction('kvs','readwrite').objectStore('kvs').put(val,key);
      w.onsuccess = () => res();
      w.onerror = () => rej(w.error);
    });
  }
  return {get,set};
})();

const $ = id => document.getElementById(id);
const SAVE_KEY = 'team-tracker-state';
const ROSTER_KEY = 'team-tracker-roster';
const LAST_SAVED_KEY = 'team-tracker-last-saved-gameId';

/* ===== State ===== */
const state = {
  opponent:'', 
  level:'U11', 
  date:null, 
  period:1,
  startedAt:new Date().toISOString(), 
  gameId:Math.random().toString(36).slice(2),
  events:[],
  countsA:{shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0},
  countsF:{shots:0, goals:0},
  team:{breakawaysAgainst:0, dzTurnovers:0},
  roster:[],
  lastEventId:0
};
let per = {1:initP(),2:initP(),3:initP(),4:initP()};
function initP(){
  return { A_shots:0, A_goals:0, A_smothers:0, A_badRebounds:0, A_bigSaves:0, F_shots:0, F_goals:0, BA:0, DZ:0 };
}

/* ===== UI Logic for Start/Setup ===== */
function toggleSetup(showSetup){
  if(showSetup){
    $('setupContainer').style.display='block';
    $('gameControls').style.display='none';
    $('btnEditSetup').style.display='none';
    $('btnUndo').style.display='none';
  } else {
    $('setupContainer').style.display='none';
    $('gameControls').style.display='block';
    $('btnEditSetup').style.display='block';
    $('btnUndo').style.display='flex';
  }
}
$('btnStartGame').addEventListener('click', ()=>{
  toggleSetup(false);
  vibrate(10);
});
$('btnEditSetup').addEventListener('click', ()=>{
  toggleSetup(true);
});

/* ===== Cloud status helper ===== */
function setCloudStatus(text, tone){
  const el = $('cloudStatus');
  if(!el) return;
  el.textContent = text;
  el.classList.remove('good','warn','bad');
  if(tone) el.classList.add(tone);
}

/* ===== Persistence ===== */
async function persistStorage(){
  try{
    if(navigator.storage && navigator.storage.persist){
      const ok = await navigator.storage.persist();
      if(ok){
        const b = $('persistBanner');
        if(b) b.classList.remove('hidden');
      }
    }
  }catch(_){}
}
async function save(){
  try{
    const json = JSON.stringify(state);
    localStorage.setItem(SAVE_KEY,json);
    await idbKV.set(SAVE_KEY,json);
  }catch(_){}
}
async function load(){
  try{
    const v = await idbKV.get(SAVE_KEY);
    if(v) return JSON.parse(v);
  }catch(_){}
  try{
    const v = localStorage.getItem(SAVE_KEY);
    if(v) return JSON.parse(v);
  }catch(_){}
  return null;
}

/* ===== Helpers ===== */
function vibrate(ms=20){ if(navigator.vibrate) navigator.vibrate(ms); }

function highlightPeriod(){
  // Update header segmented control
  [...$('periodChips').children].forEach(ch=>{
    const p = Number(ch.dataset.p);
    ch.classList.toggle('active', p===state.period);
  });
}

function fmtTime(iso){
  const d=new Date(iso);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function compressUnknown(arr){
  const unknowns = arr.filter(x=>x==='Unknown').length;
  const rest = arr.filter(x=>x!=='Unknown');
  return unknowns ? [...rest, `Unknown×${unknowns}`] : rest;
}

/* ===== Event accounting ===== */
function bump(type, period){
  const p = per[period] || per[4];
  if(type==='shot'){
    state.countsA.shots++; p.A_shots++;
  }else if(type==='goal'){
    state.countsA.shots++; state.countsA.goals++;
    p.A_shots++; p.A_goals++;
  }else if(type==='soft_goal'){
    state.countsA.shots++; state.countsA.goals++; state.countsA.softGoals++;
    p.A_shots++; p.A_goals++;
  }else if(type==='smother'){
    state.countsA.smothers++; p.A_smothers++;
  }else if(type==='bad_rebound'){
    state.countsA.shots++; state.countsA.badRebounds++;
    p.A_shots++; p.A_badRebounds++;
  }else if(type==='big_save'){
    state.countsA.bigSaves++; state.countsA.shots++;
    p.A_bigSaves++; p.A_shots++;
  }else if(type==='for_shot'){
    state.countsF.shots++; p.F_shots++;
  }else if(type==='for_goal'){
    state.countsF.shots++; state.countsF.goals++;
    p.F_shots++; p.F_goals++;
  }else if(type==='breakaway_against'){
    state.team.breakawaysAgainst++; p.BA++;
  }else if(type==='dz_turnover'){
    state.team.dzTurnovers++; p.DZ++;
  }
}

function rebuildFromEvents(){
  per = {1:initP(),2:initP(),3:initP(),4:initP()};
  state.countsA = {shots:0, goals:0, softGoals:0, smothers:0, badRebounds:0, bigSaves:0};
  state.countsF = {shots:0, goals:0};
  state.team = {breakawaysAgainst:0, dzTurnovers:0};
  for(const ev of state.events){
    bump(ev.type, ev.period);
  }
}

const pendingGood = new Map();
function scheduleGoodReboundCredit(id){
  if(pendingGood.has(id)) clearTimeout(pendingGood.get(id));
  const to = setTimeout(()=>{
    const ev = state.events.find(e=>e.id===id);
    if(ev && !ev.goodRebound){
      ev.goodRebound = true;
      save();
    }
    pendingGood.delete(id);
  }, 4000);
  pendingGood.set(id, to);
}
function cancelRecentGoodCredit(){
  const ids = [...pendingGood.keys()];
  if(!ids.length) return;
  const lastId = ids[ids.length-1];
  clearTimeout(pendingGood.get(lastId));
  pendingGood.delete(lastId);
}
function clearGoodPendingFor(id){
  if(!pendingGood.has(id)) return;
  clearTimeout(pendingGood.get(id));
  pendingGood.delete(id);
}

function addEvent(type, meta={}){
  const ev = { 
    id: ++state.lastEventId, 
    type, 
    tISO:new Date().toISOString(), 
    period: state.period, 
    ...meta 
  };
  state.events.push(ev);
  bump(type, state.period);

  if (type === 'goal' || type === 'soft_goal') tagGACause(ev);

  save();
  renderAll();
  vibrate();

  // Pulse animation trigger
  if(type==='goal' || type==='soft_goal') triggerPulse('liveGA','bad');
  if(type==='for_goal') triggerPulse('liveGF','good');

  if (type === 'shot' || type === 'big_save') scheduleGoodReboundCredit(ev.id);
  if (type === 'goal' || type === 'soft_goal') openGAContext(ev);
  return ev;
}

function triggerPulse(elemId, type){
  const el = $(elemId);
  el.classList.remove('pulse-good', 'pulse-bad');
  void el.offsetWidth; // trigger reflow
  el.classList.add(type==='good'?'pulse-good':'pulse-bad');
}

function undo(){
  const ev = state.events.pop();
  if(!ev) return;
  revert(ev);
  renderAll();
  vibrate(15);
}
function revert(ev){
  clearGoodPendingFor(ev.id);
  const p = per[ev.period] || per[4];
  if(ev.type==='shot'){ state.countsA.shots--; p.A_shots--; }
  else if(ev.type==='goal'){ state.countsA.shots--; state.countsA.goals--; p.A_shots--; p.A_goals--; }
  else if(ev.type==='soft_goal'){ state.countsA.shots--; state.countsA.goals--; state.countsA.softGoals--; p.A_shots--; p.A_goals--; }
  else if(ev.type==='smother'){ state.countsA.smothers--; p.A_smothers--; }
  else if(ev.type==='bad_rebound'){ state.countsA.shots--; state.countsA.badRebounds--; p.A_shots--; p.A_badRebounds--; }
  else if(ev.type==='big_save'){ state.countsA.bigSaves--; state.countsA.shots--; p.A_bigSaves--; p.A_shots--; }
  else if(ev.type==='for_shot'){ state.countsF.shots--; p.F_shots--; }
  else if(ev.type==='for_goal'){ state.countsF.shots--; state.countsF.goals--; p.F_shots--; p.F_goals--; }
  else if(ev.type==='breakaway_against'){ state.team.breakawaysAgainst--; p.BA--; }
  else if(ev.type==='dz_turnover'){ state.team.dzTurnovers--; p.DZ--; }
  save();
}

/* Undo Hold Logic */
let undoHoldTimer = null, undoHeld = false, undoPointerActive = false;
function startUndoHold(){ 
  if(undoPointerActive)return; 
  undoPointerActive=true; 
  undoHeld=false; 
  undoHoldTimer=setTimeout(()=>{undoHeld=true;showUndoModal();},600); 
}
function finishUndo(){ 
  if(!undoPointerActive)return; 
  undoPointerActive=false; 
  if(undoHoldTimer){clearTimeout(undoHoldTimer);undoHoldTimer=null;} 
  if(!undoHeld){undo();} 
}
function cancelUndoHold(){ 
  if(!undoPointerActive)return; 
  undoPointerActive=false; 
  if(undoHoldTimer){clearTimeout(undoHoldTimer);undoHoldTimer=null;} 
}
const undoBtn = $('btnUndo');
if(undoBtn){ 
  undoBtn.addEventListener('pointerdown',startUndoHold); 
  undoBtn.addEventListener('pointerup',finishUndo); 
  undoBtn.addEventListener('pointerleave',cancelUndoHold); 
  undoBtn.addEventListener('pointercancel',cancelUndoHold); 
}

/* Undo Modal */
let lastRemoved = null, toastTimer = null;
function showUndoModal(){
  const listEl = $('undoList');
  const recent = state.events.slice(-5);
  listEl.innerHTML = recent.length 
    ? recent.map(ev=>`<div class="undoRow" data-id="${ev.id}">P${ev.period} • ${fmtTime(ev.tISO)} — ${labelFor(ev)}</div>`).reverse().join('') 
    : `<div class="small">No events.</div>`;
  $('undoModal').style.display = 'flex';
}
$('undoList').addEventListener('click', e => {
  const row = e.target.closest('.undoRow'); 
  if(!row)return;
  const id = Number(row.dataset.id);
  const idx = state.events.findIndex(ev => ev.id === id);
  if(idx===-1) return;
  const [ev] = state.events.splice(idx,1);
  revert(ev);
  lastRemoved = ev;
  $('undoModal').style.display='none';
  showToast('Removed.');
  renderAll();
});
$('undoClose').addEventListener('click', ()=>$('undoModal').style.display='none');
function showToast(msg){
  const t=$('toast'); 
  t.firstChild.nodeValue = msg+' '; 
  t.style.display='block';
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(hideToast,3500);
}
function hideToast(){ 
  $('toast').style.display='none'; 
  if(toastTimer){clearTimeout(toastTimer);toastTimer=null;} 
}
$('toastRestore').addEventListener('click', ()=>{
  if(!lastRemoved){ hideToast(); return; }
  const ev = lastRemoved; 
  lastRemoved=null;
  state.events.push(ev); 
  state.events.sort((a,b)=>new Date(a.tISO)-new Date(b.tISO));
  rebuildFromEvents(); 
  save(); 
  renderAll(); 
  hideToast();
});

/* Labels */
function labelFor(ev){
  let label = ev.type
    .replace('soft_goal','Soft Goal')
    .replace('bad_rebound','Bad Rebound')
    .replace('for_shot','Our Shot')
    .replace('for_goal','Our Goal')
    .replace('breakaway_against','Breakaway Ag')
    .replace('dz_turnover','DZ Turnover')
    .replace(/_/g,' ');
  if((ev.type==='for_shot'||ev.type==='for_goal')&&ev.player&&ev.player!=='?'&&ev.player!=='Unknown') {
    label+=` (#${ev.player})`;
  }
  return label;
}

/* GA Context */
const GA_TAGS = ['Screen','Deflection','Cross-Crease','Weak-Side','Rush','Rebound','Other'];
let lastGAEvent = null;
function openGAContext(ev){ 
  lastGAEvent=ev; 
  $('gaGrid').innerHTML=GA_TAGS.map(t=>`<div class="pickerBtn" data-t="${t}">${t}</div>`).join(''); 
  $('gaOverlay').style.display='flex'; 
}
$('gaGrid').addEventListener('click', e=>{
  const chip=e.target.closest('.pickerBtn'); 
  if(!chip||!lastGAEvent)return;
  lastGAEvent.ga_ctx=chip.dataset.t; 
  lastGAEvent.needsContext = false;
  save(); 
  $('gaOverlay').style.display='none'; 
  renderAll();
  openMultiPicker({title:'5 Players On Ice', max:5, event:lastGAEvent, field:'onIce', exclude:[]}); 
  lastGAEvent=null;
});
$('gaSkip').addEventListener('click', ()=>{
  $('gaOverlay').style.display='none'; 
  if(lastGAEvent){
    lastGAEvent.needsContext = true;
    save();
    lastGAEvent=null;
    renderAll();
  }
});

function tagGACause(gaEv){
  const tGA = new Date(gaEv.tISO).getTime(), lookback = tGA - 10000;
  let hasBA=false, hasDZ=false, hasBR=false;
  for(const ev of state.events){
    const t = new Date(ev.tISO).getTime();
    if(t<lookback || t>tGA) continue;
    if(ev.type==='breakaway_against') hasBA=true;
    if(ev.type==='dz_turnover') hasDZ=true;
    if(ev.type==='bad_rebound') hasBR=true;
  }
  const parts=[]; 
  if(hasBA){ parts.push('BA'); gaEv.ga_ba=true; }
  if(hasDZ){ parts.push('DZ'); gaEv.ga_dz=true; }
  if(hasBR){ parts.push('BR'); gaEv.ga_br=true; }
  gaEv.ga_cause = parts.length ? parts.join('+') : 'other'; 
  save();
}

/* Multi Picker */
let multiPick = {selected:new Set(), unknowns:0, max:5, exclude:new Set(), eventRef:null, field:'onIce'};
function openMultiPicker({title,max,event,field,exclude}){
  multiPick={selected:new Set(), unknowns:0, max, exclude:new Set(exclude||[]), eventRef:event, field};
  $('onIceTitle').textContent=title; 
  $('onIceMax').textContent=String(max); 
  $('onIceModal').style.display='flex';
  buildOnIceGrid(); 
  updateOnIceMeta();
}
function buildOnIceGrid(){
  const roster=(state.roster||[]).map(x=>String(x).trim()).filter(Boolean);
  const uniq=Array.from(new Set(roster)).filter(n=>!multiPick.exclude.has(n)).sort((a,b)=>+a-+b);
  $('onIceGrid').innerHTML=uniq.length
    ? uniq.map(n=>`<div class="pickerBtn ${multiPick.selected.has(n)?'selected':''}" data-n="${n}">#${n}</div>`).join('')
    : `<div class="small" style="grid-column:1/-1;">No roster yet.</div>`;
}
function totalSelected(){ 
  return multiPick.selected.size + multiPick.unknowns; 
}
function updateOnIceMeta(){ 
  $('onIceCount').textContent=String(totalSelected()); 
  $('onIceUnknownBadge').textContent=`Unknown ×${multiPick.unknowns}`; 
}
$('onIceGrid').addEventListener('click',e=>{
  const b=e.target.closest('.pickerBtn'); 
  if(!b)return; 
  const n=b.dataset.n;
  if(multiPick.selected.has(n)){ 
    multiPick.selected.delete(n); 
    b.classList.remove('selected'); 
  }
  else{ 
    if(totalSelected()>=multiPick.max)return; 
    multiPick.selected.add(n); 
    b.classList.add('selected'); 
  }
  updateOnIceMeta();
});
$('onIceUnknownPlus').addEventListener('click', ()=>{ 
  if(totalSelected()>=multiPick.max)return; 
  multiPick.unknowns++; 
  updateOnIceMeta(); 
});
$('onIceUnknownMinus').addEventListener('click', ()=>{ 
  if(multiPick.unknowns>0){multiPick.unknowns--; updateOnIceMeta();} 
});
$('onIceClear').addEventListener('click', ()=>{ 
  multiPick.selected.clear(); 
  multiPick.unknowns=0; 
  buildOnIceGrid(); 
  updateOnIceMeta(); 
});
$('onIceUse').addEventListener('click', ()=>{
  if(!multiPick.eventRef){ 
    $('onIceModal').style.display='none'; 
    return; 
  }
  const ev=multiPick.eventRef, arr=[...multiPick.selected];
  for(let i=0;i<multiPick.unknowns;i++) arr.push('Unknown');
  ev[multiPick.field]=arr; 
  save(); 
  $('onIceModal').style.display='none'; 
  multiPick.eventRef=null; 
  renderAll();
  if(ev.type==='goal'||ev.type==='soft_goal'||ev.type==='for_goal') openStrengthPicker(ev, 'Situation (optional)');
});
$('onIceCancel').addEventListener('click', ()=>{ 
  $('onIceModal').style.display='none'; 
  multiPick.eventRef=null; 
});

/* Strength */
let strengthTarget=null;
function openStrengthPicker(ev, label){ 
  strengthTarget=ev; 
  $('strengthTitle').textContent=label; 
  $('strengthModal').style.display='flex'; 
}
$('strengthModal').addEventListener('click', e=>{
  const b=e.target.closest('.pickerBtn'); 
  if(!b||!strengthTarget)return;
  strengthTarget.strength=b.dataset.strength; 
  save(); 
  $('strengthModal').style.display='none'; 
  strengthTarget=null;
  renderAll();
});
$('strengthSkip').addEventListener('click', ()=>{ 
  $('strengthModal').style.display='none'; 
  strengthTarget=null; 
});

/* PlusMinus / Stats / Scoring */
function computePlusMinus(){
  const pm=new Map();
  function inc(n,d){ 
    if(n&&n!=='Unknown'&&n!=='?') 
      pm.set(n,(pm.get(n)||0)+d); 
  }
  for(const ev of state.events){
    if(ev.type==='for_goal'){
      const s=new Set([ev.player,ev.assist,...(ev.forOnIce||[])]);
      for(const n of s) inc(n,1);
    }
    if((ev.type==='goal'||ev.type==='soft_goal')&&ev.onIce){
      for(const n of ev.onIce) inc(n,-1);
    }
  }
  return {pm, order:[...pm.keys()].sort((a,b)=>+a-+b)};
}
const LEVEL_PROFILES = {
  U9:  { goalieBaseSV:0.75, teamFinExp:0.20, minShots:10 },
  U11: { goalieBaseSV:0.80, teamFinExp:0.17, minShots:15 },
  U13: { goalieBaseSV:0.82, teamFinExp:0.15, minShots:18 },
  U15: { goalieBaseSV:0.86, teamFinExp:0.13, minShots:22 },
  U18: { goalieBaseSV:0.89, teamFinExp:0.12, minShots:25 },
  Other:{ goalieBaseSV:0.85, teamFinExp:0.14, minShots:20 }
};
function computeGoalieScore(){
  const C=state.countsA, shots=C.shots, ga=C.goals, saves=Math.max(0,shots-ga);
  const prof = LEVEL_PROFILES[state.level]||LEVEL_PROFILES.Other;
  const volFactor = clamp01(shots/prof.minShots);
  const expectedGA = shots*(1-prof.goalieBaseSV);
  const perfNorm = shots===0 ? 0.5 : clamp01(0.5+(expectedGA-ga)/6);
  let scoreSV = 75+(perfNorm-0.5)*40*volFactor;
  
  const softPen = Math.max(-21, -7*C.softGoals);
  
  // Context penalty calc
  const gas = state.events.filter(e=>e.type==='goal'||e.type==='soft_goal');
  let ctxBad=0;
  for(const ev of gas){
    let local=0;
    const cause=ev.ga_cause||'', ctx=ev.ga_ctx||'';
    if(!cause.includes('BA') && !/Screen|Deflection|Cross-Crease/.test(ctx) && ev.strength!=='SH'){
      local+=1.0;
      if(/Rebound/.test(ctx) || cause.includes('BR')) local+=0.5;
      if(ev.type==='soft_goal') local+=0.5;
      if(ev.strength==='PP') local-=0.5;
    }
    if(local>0) ctxBad+=local;
  }
  const ctxAdj = gas.length ? -Math.min(8, (ctxBad/gas.length)*3) : 0;
  
  const rebDen = C.badRebounds + (state.events.filter(e=>e.goodRebound).length) + C.smothers;
  const scoreReb = rebDen>0 ? 6*(1-C.badRebounds/rebDen)*volFactor : 3*volFactor;
  const scoreBig = shots>0 ? Math.min(6,1.2*C.bigSaves)*clamp01(shots/15) : 0;
  
  let total = Math.round(scoreSV + softPen + ctxAdj + scoreReb + scoreBig);
  return {
    total:Math.max(0,Math.min(100,total)), 
    scoreSV:Math.round(scoreSV), 
    softPenalty:Math.round(softPen), 
    ctxAdj:Math.round(ctxAdj), 
    scoreRebound:Math.round(scoreReb), 
    scoreBig:Math.round(scoreBig), 
    goodRebounds:state.events.filter(e=>e.goodRebound).length
  };
}
function computeTeamScore(){
  const SF=state.countsF.shots, SA=state.countsA.shots, GF=state.countsF.goals, GA=state.countsA.goals;
  const SS = (SF+SA)>0 ? SF/(SF+SA) : 0.5;
  const prof = LEVEL_PROFILES[state.level]||LEVEL_PROFILES.Other;
  const Fin = SF>0 ? GF/SF : 0;
  const Impact = clamp01(0.5 + 4*((GF-GA)/Math.max(1,SF+SA)));
  
  // Consistency
  const pVals = [1,2,3,4].map(p=>per[p].F_shots+per[p].A_shots > 0 ? per[p].F_shots/(per[p].F_shots+per[p].A_shots) : null).filter(v=>v!==null);
  let stab = 1; 
  if(pVals.length>1){
    const mu=pVals.reduce((a,b)=>a+b,0)/pVals.length;
    const sig=Math.sqrt(pVals.reduce((a,b)=>a+(b-mu)**2,0)/pVals.length);
    stab = clamp01(1-(sig/0.25));
  }
  
  const scoreSS=25*SS, 
        scoreFin=25*clamp01(Fin/Math.max(0.05,prof.teamFinExp)), 
        scoreImp=35*Impact, 
        scoreStab=15*stab;
  const pen = Math.min(12, 3*state.team.breakawaysAgainst) + Math.min(12, 1.5*state.team.dzTurnovers);
  
  return {
    total:Math.round(Math.max(0,Math.min(100, scoreSS+scoreFin+scoreImp+scoreStab-pen))), 
    scoreSS, scoreFin, scoreImp, scoreStab, SS, Fin
  };
}

/* ===== Live Renders ===== */
function updateMeta(){
  const F=state.countsF, A=state.countsA;
  $('liveGF').textContent = F.goals;
  $('liveGA').textContent = A.goals;
  
  // Stats Strip
  const saves=Math.max(0,A.shots-A.goals);
  $('liveSF').textContent = F.shots;
  $('liveSA').textContent = A.shots;
  $('savesVal').textContent = saves;
  $('svVal').textContent = A.shots ? (saves/A.shots).toFixed(3).slice(1) : '—';
  
  // Rings logic
  const K=computeGoalieScore(), T=computeTeamScore();
  const setRing = (valEl,arcEl,sc) => {
    valEl.textContent=sc; 
    const c=sc>=85?'#32d74b':sc>=70?'#ff9f0a':'#ff453a';
    arcEl.style.stroke=c; 
    arcEl.style.strokeDashoffset = String(220*(1-sc/100));
  };
  setRing($('goalieScoreNum'),$('gsArc'),K.total);
  setRing($('teamScoreNum'),$('tsArc'),T.total);
  
  updateDebugLines();
}

function renderLog(){
  const logEl = $('log');
  if(!logEl) return;
  const evs = [...state.events].sort((a,b)=>new Date(a.tISO)-new Date(b.tISO));
  if(!evs.length){
    logEl.innerHTML = `<div class="small" style="opacity:0.7;">No events yet.</div>`;
    return;
  }
  logEl.innerHTML = evs.map(ev=>{
    const isGA = (ev.type==='goal' || ev.type==='soft_goal');
    const ctx = ev.ga_ctx || '';
    const cause = ev.ga_cause || '';
    const tags = [];
    if(cause) tags.push(cause);
    if(ctx) tags.push(ctx);
    if(ev.strength) tags.push(ev.strength);
    const tagText = tags.join(' • ');
    const needs = ev.needsContext && isGA;
    const meta = `P${ev.period} • ${fmtTime(ev.tISO)}`;
    return `
      <div class="log-item" data-id="${ev.id}">
        <div class="log-main">
          <span class="log-meta">${meta}</span>
          <span>${labelFor(ev)}</span>
          ${tagText ? `<span class="badge">${tagText}</span>` : ''}
        </div>
        ${needs ? `<span class="badge badge-tag" data-id="${ev.id}">Tag</span>` : ''}
      </div>`;
  }).join('');
}

/* Handle Tag Later from log */
$('log').addEventListener('click', e=>{
  const badge = e.target.closest('.badge-tag');
  if(!badge) return;
  const id = Number(badge.dataset.id);
  const ev = state.events.find(x=>x.id===id);
  if(!ev) return;
  openGAContext(ev);
});

/* ===== Summary Building ===== */
function endGame(){
  const K=computeGoalieScore(), T=computeTeamScore();
  $('summaryTitle').textContent = `${state.opponent || 'Opponent ?'} • ${state.level || '?'} • ${state.date || (new Date().toISOString().slice(0,10))}`;
  $('scoreBreakdown').textContent = `SV: ${K.scoreSV} | Ctx: ${K.ctxAdj} | Soft: ${K.softPenalty} | Reb: ${K.scoreRebound} | Big: ${K.scoreBig}`;
  $('teamBreakdown').textContent = `Possession: ${Math.round(T.scoreSS)} | Finish: ${Math.round(T.scoreFin)} | Result: ${Math.round(T.scoreImp)} | Consistency: ${Math.round(T.scoreStab)}`;
  
  // Period table
  let html = `<table><tr><th>P</th><th>SF</th><th>SA</th><th>GF</th><th>GA</th></tr>`;
  for(let p=1;p<=4;p++){
    const v=per[p];
    html+=`<tr><td>${p===4?'OT':p}</td><td>${v.F_shots}</td><td>${v.A_shots}</td><td>${v.F_goals}</td><td>${v.A_goals}</td></tr>`;
  }
  html+=`</table>`;
  $('summaryTableWrap').innerHTML=html;
  $('pmTableWrap').innerHTML=makePlusMinusTable();
  
  // GA detail summary
  const gaStats = state.events.reduce((acc,e)=>{
      if(e.type==='goal'||e.type==='soft_goal'){
          const c=e.ga_cause||'';
          if(e.ga_ba||c.includes('BA')) acc.BA++;
          else if(e.ga_dz||c.includes('DZ')) acc.DZ++;
          else if(e.ga_br||c.includes('BR')) acc.BR++;
          else acc.Other++;
      }
      return acc;
  }, {BA:0,DZ:0,BR:0,Other:0});
  $('gaDetailWrap').innerHTML = `
    <div class="small">
      Goals Against Breakdown: 
      BA: ${gaStats.BA} • DZ: ${gaStats.DZ} • BR: ${gaStats.BR} • Other: ${gaStats.Other}
    </div>
  `;
  
  // Readable text summary
  const SF=state.countsF.shots, SA=state.countsA.shots, GF=state.countsF.goals, GA=state.countsA.goals;
  const saves=Math.max(0,SA-GA);
  const svText = SA ? (saves/SA).toFixed(3).slice(1) : '—';
  const line1 = `Level ${state.level || '?'} vs ${state.opponent || 'Unknown opponent'} on ${state.date || new Date().toISOString().slice(0,10)}.`;
  const line2 = `Score: Us ${GF} – ${GA} Them. Shots: SF ${SF}, SA ${SA}, Saves ${saves}, SV% ${svText}.`;
  const line3 = `Team Score: ${T.total}/100. Goalie Score: ${K.total}/100. Breakaways Against: ${state.team.breakawaysAgainst}, DZ Turnovers: ${state.team.dzTurnovers}.`;
  $('summaryReadable').textContent = `${line1} ${line2} ${line3}`;
  
  $('summaryPanel').classList.remove('hidden');
  window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  
  // Build condensed gameData for Airtable
  const gameData = {
      Date: state.date||new Date().toISOString().slice(0,10), 
      Opponent: state.opponent, 
      Level: state.level,
      TeamScore: T.total, 
      GoalieScore: K.total,
      SF: state.countsF.shots, 
      SA: state.countsA.shots, 
      GF: state.countsF.goals, 
      GA: state.countsA.goals,
      BreakawaysAgainst: state.team.breakawaysAgainst, 
      DZTurnovers: state.team.dzTurnovers,
      Smothers: state.countsA.smothers, 
      BadRebounds: state.countsA.badRebounds, 
      BigSaves: state.countsA.bigSaves, 
      SoftGoals: state.countsA.softGoals,
      GA_BA: gaStats.BA, 
      GA_DZ: gaStats.DZ, 
      GA_BR: gaStats.BR, 
      GA_Other: gaStats.Other
  };
  saveGameToAirtable(gameData);
}

async function saveGameToAirtable(game){
  try{
    setCloudStatus('Cloud: Saving…','warn');
    const res = await fetch('/api/save-game',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({game})
    });
    const d=await res.json();
    if(d.success){
      setCloudStatus('Cloud: Saved','good');
      alert('Saved to Airtable!');
    }else{
      setCloudStatus('Cloud: Error','bad');
      alert('Save Failed');
    }
  }catch(e){ 
    console.error(e); 
    setCloudStatus('Cloud: Error','bad');
    alert('Error saving.'); 
  }
}

/* CSV Helpers */
function buildGameRow(K,T){
  const SF=state.countsF.shots, SA=state.countsA.shots, GF=state.countsF.goals, GA=state.countsA.goals;
  const saves=Math.max(0,SA-GA);
  const svText = SA ? (saves/SA).toFixed(3).slice(1) : '';
  return { 
    date: state.date||new Date().toISOString().slice(0,10),
    opponent: state.opponent||'',
    level: state.level||'',
    teamScore: T.total,
    goalieScore: K.total,
    SF, SA, GF, GA,
    saves,
    sv: svText,
    breakawaysAgainst: state.team.breakawaysAgainst,
    dzTurnovers: state.team.dzTurnovers,
    smothers: state.countsA.smothers,
    badRebounds: state.countsA.badRebounds,
    bigSaves: state.countsA.bigSaves,
    softGoals: state.countsA.softGoals
  }; 
}

function exportGameCSV(){
  const K=computeGoalieScore(), T=computeTeamScore();
  const row = buildGameRow(K,T);
  const headers = Object.keys(row);
  const values = headers.map(h => {
    const v = row[h]==null ? '' : String(row[h]);
    return `"${v.replace(/"/g,'""')}"`;
  });
  const csv = headers.join(',') + '\n' + values.join(',');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download = `team-tracker-${row.date || 'game'}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* Debug placeholders */
function updateDebugLines(){} 

function makePlusMinusTable(){
  const {pm, order} = computePlusMinus();
  if(!order.length) return '<div class="small" style="margin-top:4px;">No plus/minus data.</div>';
  let html = '<table><tr><th>#</th><th>+/-</th></tr>';
  for(const n of order){
    const val = pm.get(n);
    html += `<tr><td>${n}</td><td>${val>0?'+':''}${val}</td></tr>`;
  }
  html += '</table>';
  return html;
}

/* Roster Modal */
function openRoster(){
  const area = $('rosterArea');
  area.value = (state.roster||[]).join('\n');
  $('rosterModal').style.display='flex';
}
function saveRosterFromArea(){
  const raw = $('rosterArea').value.split('\n').map(x=>x.trim()).filter(x=>x.length>0);
  state.roster = raw;
  localStorage.setItem(ROSTER_KEY, JSON.stringify(state.roster));
  save();
  $('rosterModal').style.display='none';
}
function closeRoster(){
  $('rosterModal').style.display='none';
}

/* Player picker */
let pickerTargetType = null;
function openPicker(type,label){
  pickerTargetType = type;
  $('pickerTitle').textContent = label || 'Select Player';
  const roster=(state.roster||[]).map(x=>String(x).trim()).filter(Boolean);
  const uniq=Array.from(new Set(roster)).sort((a,b)=>+a-+b);
  $('pickerGrid').innerHTML = uniq.length
    ? uniq.map(n=>`<div class="pickerBtn" data-n="${n}">#${n}</div>`).join('')
    : `<div class="small" style="grid-column:1/-1;">No roster yet. Type a number below.</div>`;
  $('pickerInput').value='';
  $('pickerModal').style.display='flex';
}
$('pickerGrid').addEventListener('click', e=>{
  const b=e.target.closest('.pickerBtn'); 
  if(!b)return;
  $('pickerInput').value = b.dataset.n;
});
$('pickerAdd').addEventListener('click', ()=>{
  const num = $('pickerInput').value.trim() || '?';
  applyPickerSelection(num);
});
$('pickerUnknown').addEventListener('click', ()=>{
  applyPickerSelection('Unknown');
});
$('pickerCancel').addEventListener('click', ()=>{
  $('pickerModal').style.display='none';
  pickerTargetType=null;
});
function applyPickerSelection(num){
  if(!pickerTargetType){ 
    $('pickerModal').style.display='none'; 
    return; 
  }
  if(pickerTargetType==='for_shot'){
    addEvent('for_shot',{player:num});
  }else if(pickerTargetType==='for_goal'){
    const ev = addEvent('for_goal',{player:num});
    // Optionally tag on-ice for GF later via GA-like flow if desired
    openMultiPicker({title:'Forwards On Ice (optional)', max:5, event:ev, field:'forOnIce', exclude:[num]});
  }
  $('pickerModal').style.display='none';
  pickerTargetType=null;
}

/* Init */
(function init(){
  $('date').valueAsDate = new Date();
  try{ state.roster = JSON.parse(localStorage.getItem(ROSTER_KEY))||[]; }catch(_){}
  persistStorage();
  load().then(loaded=>{
    if(loaded && Array.isArray(loaded.events)){
        Object.assign(state,loaded);
        state.events.sort((a,b)=>new Date(a.tISO)-new Date(b.tISO));
        rebuildFromEvents();
        $('resumeBanner').classList.remove('hidden');
        if(state.events.length>0) toggleSetup(false); // Auto-hide setup if resuming
    }
    updateMeta();
    highlightPeriod();
    if(state.events.length>0) renderAll();
  });
})();

function renderAll(){
  rebuildFromEvents();
  updateMeta();
  renderLog();
}

/* Button Wiring */
$('btnRoster').onclick=openRoster; 
$('btnRosterSave').onclick=saveRosterFromArea; 
$('btnRosterClose').onclick=closeRoster;

$('btnShot').onclick=()=>addEvent('shot'); 
$('btnGoal').onclick=()=>addEvent('goal');

$('btnForShot').onclick=()=>openPicker('for_shot','Shooter'); 
$('btnForGoal').onclick=()=>openPicker('for_goal','Scorer');

$('btnSoftGoal').onclick=()=>addEvent('soft_goal'); 
$('btnBadRebound').onclick=()=>addEvent('bad_rebound');
$('btnBreakaway').onclick=()=>addEvent('breakaway_against'); 
$('btnDZTurnover').onclick=()=>addEvent('dz_turnover');
$('btnSmother').onclick=()=>addEvent('smother'); 
$('btnBigSave').onclick=()=>addEvent('big_save');

$('periodChips').addEventListener('click',e=>{
    const c=e.target.closest('.p-opt'); 
    if(!c)return;
    state.period=Number(c.dataset.p); 
    save(); 
    highlightPeriod();
});

$('btnNextPeriod').onclick=()=>{ 
  state.period=Math.min(4,state.period+1); 
  save(); 
  highlightPeriod(); 
  vibrate(20); 
};

$('btnEnd').onclick=endGame;
$('btnReset').onclick=()=>{
    if(!confirm('Clear game?'))return;
    state.events=[]; 
    state.opponent=''; 
    state.countsA={shots:0,goals:0,softGoals:0,smothers:0,badRebounds:0,bigSaves:0}; 
    state.countsF={shots:0,goals:0}; 
    state.team={breakawaysAgainst:0,dzTurnovers:0};
    per={1:initP(),2:initP(),3:initP(),4:initP()};
    save(); 
    toggleSetup(true); 
    renderAll(); 
    $('summaryPanel').classList.add('hidden');
};

/* Modals close on backdrop click */
document.querySelectorAll('.modal').forEach(m=>
  m.addEventListener('click',e=>{if(e.target===m)m.style.display='none';})
);

/* Inputs */
$('opponent').oninput=e=>{state.opponent=e.target.value;save();}
$('level').onchange=e=>{state.level=e.target.value;save();}
$('date').onchange=e=>{state.date=e.target.value;save();}

/* Copy Summary */
$('btnCopySummary').addEventListener('click', ()=>{
  const text = $('summaryReadable').textContent || '';
  $('copyArea').value = text;
  $('copyModal').style.display='flex';
  if(navigator.clipboard && text){
    navigator.clipboard.writeText(text).catch(()=>{});
  }
});
$('btnCopySelect').addEventListener('click', ()=>{
  const area = $('copyArea');
  area.focus();
  area.select();
});
$('btnCopyClose').addEventListener('click', ()=>{
  $('copyModal').style.display='none';
});

/* Export CSV */
$('btnExportGameCSV').addEventListener('click', exportGameCSV);

/* Debug AI buttons: no-op for now */
$('btnSaveSeason').addEventListener('click', ()=>{ /* handled server-side via Airtable save */ });
$('btnAIPractice').addEventListener('click', ()=>{ /* placeholder */ });
$('btnAIGoalieReport').addEventListener('click', ()=>{ /* placeholder */ });
$('btnAIFocus').addEventListener('click', ()=>{ /* placeholder */ });

</script>
</body>
</html>
